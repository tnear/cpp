# LLVM Machine Code Analyzer (MCA)

https://llvm.org/docs/CommandGuide/llvm-mca.html

`llvm-mca` is a performance analysis tool that uses information available in LLVM to statically measure the performance of machine code on a specific CPU.

## Example (simple)
In Godbolt, click 'Add tool' in the assembly output pane and add `llvm-mca (trunk)`.

For programming language, select `Analysis`. Paste in the assembly code (generated by Compiler Explorer):

```
.LBB0_6:
    movdqu  xmm2, xmmword ptr [r8 + 4*rax]
    paddd   xmm0, xmm2
    movdqu  xmm2, xmmword ptr [r8 + 4*rax + 16]
    paddd   xmm1, xmm2
    add     rax, 8
    cmp     rdi, rax
    jne     .LBB0_6
```

Then choose `llvm-mca (trunk)` for the compiler. The `-timeline` flag can show when instructions get Decoded/executing/stalled/etc:

```
Index     0123456789

[0,0]     DeeeeeeER .   movdqu       xmm2, xmmword ptr [r8 + 4*rax]
[0,1]     D======eER.   paddd        xmm0, xmm2
[0,2]     DeeeeeeE-R.   movdqu       xmm2, xmmword ptr [r8 + 4*rax + 16]
[0,3]     D======eER.   paddd        xmm1, xmm2
[0,4]     DeE------R.   add  rax, 8
[0,5]     D=eE-----R.   cmp  rdi, rax
[0,6]     .D=eE----R.   jne  .LBB0_6
```

## Example (full)
Example pulled from *https://youtu.be/kIoZDUd5DKw?t=1519*.

```cpp
int accum(const vector<int> &v)
{
    int result = 0;
    for (int value : v)
        result += value;
    return result;
}
```

MCA output:

```
Iterations:        100
Instructions:      4200
Total Cycles:      1215
Total uOps:        4700

Dispatch Width:    6
uOps Per Cycle:    3.87
IPC:               3.46
Block RThroughput: 7.8

Instruction Info:
[1]: #uOps (micro-operations)
[2]: Latency (how many clock cycles until result is ready)
[3]: RThroughput (reciprocal throughput. 0.24 means 4 of these instructions can stat on same clock cycle)
[4]: MayLoad
[5]: MayStore
[6]: HasSideEffects (U)

[1]    [2]    [3]    [4]   [6]    Instructions:
 1      5     0.50    *           mov	r8, qword ptr [rdi]
 1      5     0.50    *           mov	rcx, qword ptr [rdi + 8]
 1      1     0.25                cmp	r8, rcx
 1      1     0.50                je	.LBB0_1
 1      1     0.25                mov	rsi, rcx
 1      1     0.25                sub	rsi, r8
 1      1     0.25                add	rsi, -4
 1      0     0.17                xor	eax, eax
 1      1     0.25                cmp	rsi, 28
 1      1     0.50                jae	.LBB0_5
 1      1     0.25                mov	rdx, r8
 1      1     0.50                jmp	.LBB0_8
 1      0     0.17                xor	eax, eax
 3      7     1.00          U     ret
 1      1     0.50                shr	rsi, 2
 1      1     0.25                inc	rsi
 1      1     0.25                mov	rdi, rsi
 1      1     0.25                and	rdi, -8
 1      1     0.50                lea	rdx, [r8 + 4*rdi]
 1      0     0.17                pxor	xmm0, xmm0
 1      0     0.17                xor	eax, eax
 1      0     0.17                pxor	xmm1, xmm1
 1      6     0.50    *           movdqu	xmm2, xmmword ptr [r8 + 4*rax]
 1      1     0.33                paddd	xmm0, xmm2
 1      6     0.50    *           movdqu	xmm2, xmmword ptr [r8 + 4*rax + 16]
 1      1     0.33                paddd	xmm1, xmm2
 1      1     0.25                add	rax, 8
 1      1     0.25                cmp	rdi, rax
 1      1     0.50                jne	.LBB0_6
 1      1     0.33                paddd	xmm1, xmm0
 1      1     0.50                pshufd	xmm0, xmm1, 238
 1      1     0.33                paddd	xmm0, xmm1
 1      1     0.50                pshufd	xmm1, xmm0, 85
 1      1     0.33                paddd	xmm1, xmm0
 1      2     1.00                movd	eax, xmm1
 1      1     0.25                cmp	rsi, rdi
 1      1     0.50                je	.LBB0_2
 2      6     0.50    *           add	eax, dword ptr [rdx]
 1      1     0.25                add	rdx, 4
 1      1     0.25                cmp	rdx, rcx
 1      1     0.50                jne	.LBB0_8
 3      7     1.00          U     ret

Resources:
[0]   - ICXDivider
[1]   - ICXFPDivider
[2]   - ICXPort0
...
[11]  - ICXPort9

Resource pressure per iteration:
[2]    [3]    [4]    [5]    [6]    [7]    [8]
8.76   8.74   3.50   3.50    -     8.74   8.76

Resource pressure by instruction:
[2]    [3]    [4]    [5]    [6]    [7]    [8]    Instructions:
 -      -     0.50   0.50    -      -      -     mov	r8, qword ptr [rdi]
 -      -     0.50   0.50    -      -      -     mov	rcx, qword ptr [rdi + 8]
0.01   0.72    -      -      -     0.02   0.25   cmp	r8, rcx
0.73    -      -      -      -      -     0.27   je	.LBB0_1
0.25   0.01    -      -      -     0.27   0.47   mov	rsi, rcx
 -     0.29    -      -      -     0.70   0.01   sub	rsi, r8
 -     0.23    -      -      -     0.30   0.47   add	rsi, -4
 -      -      -      -      -      -      -     xor	eax, eax
0.28   0.24    -      -      -     0.48    -     cmp	rsi, 28
0.76    -      -      -      -      -     0.24   jae	.LBB0_5
0.01   0.71    -      -      -      -     0.28   mov	rdx, r8
0.74    -      -      -      -      -     0.26   jmp	.LBB0_8
 -      -      -      -      -      -      -     xor	eax, eax
0.47   0.49   0.50   0.50    -     0.04   1.00   ret
0.71    -      -      -      -      -     0.29   shr	rsi, 2
 -      -      -      -      -     1.00    -     inc	rsi
 -     1.00    -      -      -      -      -     mov	rdi, rsi
0.25   0.01    -      -      -     0.27   0.47   and	rdi, -8
 -     0.26    -      -      -     0.74    -     lea	rdx, [r8 + 4*rdi]
 -      -      -      -      -      -      -     pxor	xmm0, xmm0
 -      -      -      -      -      -      -     xor	eax, eax
 -      -      -      -      -      -      -     pxor	xmm1, xmm1
 -      -     0.03   0.97    -      -      -     movdqu	xmm2, xmmword ptr [r8 + 4*rax]
0.26   0.26    -      -      -     0.48    -     paddd	xmm0, xmm2
 -      -     0.97   0.03    -      -      -     movdqu	xmm2, xmmword ptr [r8 + 4*rax + 16]
0.51   0.48    -      -      -     0.01    -     paddd	xmm1, xmm2
0.01   0.51    -      -      -     0.47   0.01   add	rax, 8
0.01    -      -      -      -      -     0.99   cmp	rdi, rax
0.24    -      -      -      -      -     0.76   jne	.LBB0_6
0.27   0.48    -      -      -     0.25    -     paddd	xmm1, xmm0
 -     0.28    -      -      -     0.72    -     pshufd	xmm0, xmm1, 238
0.24   0.26    -      -      -     0.50    -     paddd	xmm0, xmm1
 -     0.50    -      -      -     0.50    -     pshufd	xmm1, xmm0, 85
0.26   0.24    -      -      -     0.50    -     paddd	xmm1, xmm0
1.00    -      -      -      -      -      -     movd	eax, xmm1
0.48   0.26    -      -      -     0.25   0.01   cmp	rsi, rdi
0.75    -      -      -      -      -     0.25   je	.LBB0_2
 -     0.02   0.49   0.51    -     0.73   0.25   add	eax, dword ptr [rdx]
 -     0.72    -      -      -     0.28    -     add	rdx, 4
0.26    -      -      -      -      -     0.74   cmp	rdx, rcx
0.26    -      -      -      -      -     0.74   jne	.LBB0_8
 -     0.77   0.51   0.49    -     0.23   1.00   ret
warning: found a return instruction in the input assembly sequence.
note: program counter updates are ignored.
```
